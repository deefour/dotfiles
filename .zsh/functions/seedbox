# In your .zshenv.local export the following variables to work
# with this seedbox function
#
#  - D4_SEEDBOX_ID: your seedbox's AWS EC2 instance ID
#  - D4_SEEDBOX_IP: a free elastic IP to associate with the instance
#
# This function assumes you have the Amazon EC2 API Tools installed
# and available on $PATH.
seedbox () {
  mode="$1"

  command -v ec2-start-instances >/dev/null 2>&1 || {
    echo >&2 "The seedbox command require the Amazon EC2 API Tools be installed and available in \$PATH."
    return
  }

  if [[ "$mode" == "up" ]]
  then
    echo -e "\e[34;1mStarting up the seedbox...\e[0m"

    ec2-start-instances $D4_SEEDBOX_ID > /dev/null &&
    ec2-associate-address $D4_SEEDBOX_IP -i $D4_SEEDBOX_ID > /dev/null &&

    echo "The seedbox will be ready in a minute or two."
  elif [[ "$mode" == "down" ]]
  then
    echo -e "\e[34;1mStopping the seedbox...\e[0m"

    ec2-stop-instances $D4_SEEDBOX_ID > /dev/null &&

    echo "The seedbox has been \e[31;1mstopped\e[0m"
  elif [[ "$mode" == "down" ]]
  then
    echo -e "Pulling files from \e[34;1m${D4_SEEDBOX_SOURCE}\e[0m on the seedbox down to \e[32;1m${D4_SEEDBOX_DESTINATION}\e[0m..."
    rsync -uvzr --progress --remove-source-files -e ssh "${D4_SEEDBOX_SSH}:${D4_SEEDBOX_SOURCE} ${D4_SEEDBOX_DESTINATION}"
  elif [[ -n "$mode" ]]
  then
    echo -e "Invalid argument. Only \e[32;1mup\e[0m, \e[32;1mdown\e[0m, and \e[32;1mpull\e[0m are allowed"
    return
  else

    stat=`ec2-describe-instance-status $D4_SEEDBOX_ID | cut -f8`

    echo -e "The seedbox is currently \e[34;1m${stat:=stopped}\e[0m"
  fi
}
